# Backend API Specification for Stock Market Application

## Document Purpose
This document serves as a comprehensive specification for building an ASP.NET Core backend API to replace the current json-server mock backend. The goal is to create a production-ready API that the Angular frontend can consume with minimal code changes (only updating the `apiUrl`).

---

## Current Frontend Architecture

### Technology Stack
- **Framework**: Angular 20.3.0
- **Language**: TypeScript 5.9.2
- **HTTP Client**: Angular HttpClient
- **State Management**: RxJS Observables
- **Current Mock API**: json-server on `http://localhost:3000`

### Frontend Project Structure
```
src/app/
├── model/
│   └── stock.ts                    # Stock data model
├── services/
│   └── stock-service.ts            # HTTP service for API calls
├── stock-list/                     # List view component
├── stock-details-component/        # Detail view component
├── create-stock/                   # Create stock component
└── stock-item/                     # Stock item component
```

---

## Data Model

### Stock Entity
The frontend expects the following JSON structure for stock data:

```typescript
{
  id?: string;              // Optional, auto-generated by backend
  name: string;             // Company full name
  code: string;             // Stock ticker symbol (e.g., "MSFT", "AAPL")
  price: number;            // Current stock price
  previousPrice: number;    // Previous closing price
  exchange: string;         // Stock exchange (e.g., "NASDAQ", "NYSE")
  favorite: boolean;        // User favorite flag
}
```

### Sample Data Structure
```json
{
  "id": "2",
  "name": "Microsoft Corporation",
  "code": "MSFT",
  "price": 382.75,
  "previousPrice": 380.1,
  "exchange": "NASDAQ",
  "favorite": true
}
```

---

## API Endpoints Required

The frontend currently makes the following HTTP requests:

### 1. GET /stocks
**Purpose**: Retrieve all stocks  
**Method**: GET  
**URL**: `{baseUrl}/stocks`  
**Request Headers**: 
- `Content-Type: application/json`

**Expected Response**:
- **Status Code**: 200 OK
- **Body**: Array of Stock objects
```json
[
  {
    "id": "2",
    "name": "Microsoft Corporation",
    "code": "MSFT",
    "price": 382.75,
    "previousPrice": 380.1,
    "exchange": "NASDAQ",
    "favorite": true
  },
  {
    "id": "4",
    "name": "Amazon.com Inc.",
    "code": "AMZN",
    "price": 145.25,
    "previousPrice": 142.9,
    "exchange": "NASDAQ",
    "favorite": true
  }
]
```

**Frontend Usage**:
```typescript
this.http.get<Stock[]>(this.apiUrl)
```

---

### 2. GET /stocks/{id}
**Purpose**: Retrieve a single stock by ID  
**Method**: GET  
**URL**: `{baseUrl}/stocks/{id}`  
**URL Parameters**:
- `id` (string/number): Stock identifier

**Expected Response**:
- **Status Code**: 200 OK
- **Body**: Single Stock object
```json
{
  "id": "2",
  "name": "Microsoft Corporation",
  "code": "MSFT",
  "price": 382.75,
  "previousPrice": 380.1,
  "exchange": "NASDAQ",
  "favorite": true
}
```

**Error Response**:
- **Status Code**: 404 Not Found (if stock doesn't exist)

**Frontend Usage**:
```typescript
const url = `${this.apiUrl}/${id}`;
this.http.get<Stock>(url)
```

---

### 3. POST /stocks
**Purpose**: Create a new stock  
**Method**: POST  
**URL**: `{baseUrl}/stocks`  
**Request Headers**:
- `Content-Type: application/json`

**Request Body**:
```json
{
  "name": "Apple Inc.",
  "code": "AAPL",
  "price": 175.50,
  "previousPrice": 173.20,
  "exchange": "NASDAQ",
  "favorite": false
}
```

**Expected Response**:
- **Status Code**: 201 Created
- **Body**: Created Stock object with generated ID
```json
{
  "id": "11",
  "name": "Apple Inc.",
  "code": "AAPL",
  "price": 175.50,
  "previousPrice": 173.20,
  "exchange": "NASDAQ",
  "favorite": false
}
```

**Frontend Usage**:
```typescript
this.http.post<Stock>(this.apiUrl, stock)
```

---

### 4. DELETE /stocks/{id}
**Purpose**: Delete a stock by ID  
**Method**: DELETE  
**URL**: `{baseUrl}/stocks/{id}`  
**URL Parameters**:
- `id` (string/number): Stock identifier

**Expected Response**:
- **Status Code**: 200 OK or 204 No Content
- **Body**: Empty or success message

**Error Response**:
- **Status Code**: 404 Not Found (if stock doesn't exist)

**Frontend Usage**:
```typescript
const url = `${this.apiUrl}/${stockToRemove.id}`;
this.http.delete(url)
```

---

## Frontend Service Implementation

The frontend service (`stock-service.ts`) is implemented as follows:

```typescript
@Injectable({
  providedIn: 'root',
})
export class StockService {
  private apiUrl = 'http://localhost:3000/stocks';  // ONLY THIS LINE NEEDS TO CHANGE

  constructor(private http: HttpClient) {}

  getStocks(): Observable<Stock[]> {
    return this.http.get<Stock[]>(this.apiUrl);
  }

  addStock(stock: Stock): Observable<Stock> {
    return this.http.post<Stock>(this.apiUrl, stock);
  }

  removeStock(stockToRemove: Stock): Observable<any> {
    const url = `${this.apiUrl}/${stockToRemove.id}`;
    return this.http.delete(url);
  }

  getStockById(id: number): Observable<Stock> {
    const url = `${this.apiUrl}/${id}`;
    return this.http.get<Stock>(url);
  }
}
```

**Critical Note**: The only change required in the frontend is updating the `apiUrl` from `http://localhost:3000/stocks` to the new backend URL (e.g., `http://your-fedora-server:5000/api/stocks`).

---

## ASP.NET Core Backend Implementation Guide

### Prerequisites
- .NET 8.0 SDK or later
- Entity Framework Core
- Database (SQL Server, PostgreSQL, or SQLite for development)
- Fedora Linux server environment

---

### Step 1: Create ASP.NET Core Web API Project

```bash
dotnet new webapi -n StockMarketAPI
cd StockMarketAPI
```

Install required NuGet packages:
```bash
dotnet add package Microsoft.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.Design
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
# OR for PostgreSQL
dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL
# OR for SQLite (development)
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
```

---

### Step 2: Create the Stock Model

Create `Models/Stock.cs`:

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace StockMarketAPI.Models
{
    public class Stock
    {
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public string Id { get; set; }
        
        [Required]
        [StringLength(200)]
        public string Name { get; set; }
        
        [Required]
        [StringLength(10)]
        public string Code { get; set; }
        
        [Required]
        [Column(TypeName = "decimal(18,2)")]
        public decimal Price { get; set; }
        
        [Required]
        [Column(TypeName = "decimal(18,2)")]
        public decimal PreviousPrice { get; set; }
        
        [Required]
        [StringLength(50)]
        public string Exchange { get; set; }
        
        [Required]
        public bool Favorite { get; set; }
    }
}
```

**Important Notes**:
- Use `string` for `Id` to match frontend expectation
- Use `decimal` for price fields to ensure precision
- Add validation attributes for data integrity
- Property names must match JSON exactly (case-sensitive)

---

### Step 3: Create Database Context

Create `Data/StockDbContext.cs`:

```csharp
using Microsoft.EntityFrameworkCore;
using StockMarketAPI.Models;

namespace StockMarketAPI.Data
{
    public class StockDbContext : DbContext
    {
        public StockDbContext(DbContextOptions<StockDbContext> options)
            : base(options)
        {
        }

        public DbSet<Stock> Stocks { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            
            // Seed initial data
            modelBuilder.Entity<Stock>().HasData(
                new Stock
                {
                    Id = "2",
                    Name = "Microsoft Corporation",
                    Code = "MSFT",
                    Price = 382.75m,
                    PreviousPrice = 380.1m,
                    Exchange = "NASDAQ",
                    Favorite = true
                },
                new Stock
                {
                    Id = "4",
                    Name = "Amazon.com Inc.",
                    Code = "AMZN",
                    Price = 145.25m,
                    PreviousPrice = 142.9m,
                    Exchange = "NASDAQ",
                    Favorite = true
                },
                new Stock
                {
                    Id = "5",
                    Name = "Alphabet Inc.",
                    Code = "GOOGL",
                    Price = 138.65m,
                    PreviousPrice = 140.2m,
                    Exchange = "NASDAQ",
                    Favorite = false
                },
                new Stock
                {
                    Id = "6",
                    Name = "Meta Platforms Inc.",
                    Code = "META",
                    Price = 325.4m,
                    PreviousPrice = 318.75m,
                    Exchange = "NASDAQ",
                    Favorite = false
                },
                new Stock
                {
                    Id = "7",
                    Name = "NVIDIA Corporation",
                    Code = "NVDA",
                    Price = 485.2m,
                    PreviousPrice = 478.9m,
                    Exchange = "NASDAQ",
                    Favorite = true
                },
                new Stock
                {
                    Id = "8",
                    Name = "JPMorgan Chase & Co.",
                    Code = "JPM",
                    Price = 158.3m,
                    PreviousPrice = 160.45m,
                    Exchange = "NYSE",
                    Favorite = false
                },
                new Stock
                {
                    Id = "9",
                    Name = "Johnson & Johnson",
                    Code = "JNJ",
                    Price = 162.85m,
                    PreviousPrice = 161.2m,
                    Exchange = "NYSE",
                    Favorite = false
                },
                new Stock
                {
                    Id = "10",
                    Name = "Visa Inc.",
                    Code = "V",
                    Price = 275.9m,
                    PreviousPrice = 272.4m,
                    Exchange = "NYSE",
                    Favorite = true
                }
            );
        }
    }
}
```

---

### Step 4: Configure Database Connection

Update `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StockMarketDB;User Id=your_user;Password=your_password;TrustServerCertificate=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:5000"
      }
    }
  }
}
```

**For PostgreSQL**, use:
```json
"DefaultConnection": "Host=localhost;Database=StockMarketDB;Username=your_user;Password=your_password"
```

**For SQLite** (development), use:
```json
"DefaultConnection": "Data Source=stockmarket.db"
```

---

### Step 5: Create the Stocks Controller

Create `Controllers/StocksController.cs`:

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using StockMarketAPI.Data;
using StockMarketAPI.Models;

namespace StockMarketAPI.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class StocksController : ControllerBase
    {
        private readonly StockDbContext _context;

        public StocksController(StockDbContext context)
        {
            _context = context;
        }

        // GET: api/stocks
        [HttpGet]
        public async Task<ActionResult<IEnumerable<Stock>>> GetStocks()
        {
            return await _context.Stocks.ToListAsync();
        }

        // GET: api/stocks/5
        [HttpGet("{id}")]
        public async Task<ActionResult<Stock>> GetStock(string id)
        {
            var stock = await _context.Stocks.FindAsync(id);

            if (stock == null)
            {
                return NotFound();
            }

            return stock;
        }

        // POST: api/stocks
        [HttpPost]
        public async Task<ActionResult<Stock>> PostStock(Stock stock)
        {
            // Generate ID if not provided
            if (string.IsNullOrEmpty(stock.Id))
            {
                stock.Id = Guid.NewGuid().ToString();
            }

            _context.Stocks.Add(stock);
            await _context.SaveChangesAsync();

            return CreatedAtAction(nameof(GetStock), new { id = stock.Id }, stock);
        }

        // DELETE: api/stocks/5
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteStock(string id)
        {
            var stock = await _context.Stocks.FindAsync(id);
            if (stock == null)
            {
                return NotFound();
            }

            _context.Stocks.Remove(stock);
            await _context.SaveChangesAsync();

            return NoContent();
        }
    }
}
```

**Critical Implementation Notes**:
- Route must be `api/stocks` (lowercase) to match frontend
- Use async/await for all database operations
- Return proper HTTP status codes (200, 201, 204, 404)
- Generate ID automatically if not provided in POST
- Use `string` type for ID parameter to match model

---

### Step 6: Configure Services in Program.cs

Update `Program.cs`:

```csharp
using Microsoft.EntityFrameworkCore;
using StockMarketAPI.Data;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.PropertyNamingPolicy = null; // Preserve PascalCase
    });

// Configure Database
builder.Services.AddDbContext<StockDbContext>(options =>
{
    // For SQL Server
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"));
    
    // OR for PostgreSQL
    // options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection"));
    
    // OR for SQLite
    // options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection"));
});

// Configure CORS for Angular frontend
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAngularApp",
        policy =>
        {
            policy.WithOrigins("http://localhost:4200") // Angular dev server
                  .AllowAnyHeader()
                  .AllowAnyMethod();
        });
});

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// Enable CORS
app.UseCors("AllowAngularApp");

app.UseAuthorization();

app.MapControllers();

app.Run();
```

**CORS Configuration is Critical**:
- Must allow `http://localhost:4200` for local development
- Must allow the production frontend URL when deployed
- Must allow all headers and methods (GET, POST, DELETE)

---

### Step 7: Create and Apply Database Migration

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

This will:
1. Create the database schema
2. Seed the initial stock data
3. Prepare the database for use

---

### Step 8: Build and Run the API

```bash
dotnet build
dotnet run
```

The API will be available at:
- `http://localhost:5000/api/stocks`
- Swagger UI: `http://localhost:5000/swagger`

---

## Deployment on Fedora Server

### Step 1: Install .NET Runtime on Fedora

```bash
sudo dnf install dotnet-sdk-8.0
```

### Step 2: Publish the Application

On development machine:
```bash
dotnet publish -c Release -o ./publish
```

### Step 3: Transfer Files to Fedora Server

```bash
scp -r ./publish user@fedora-server:/var/www/stockmarket-api
```

### Step 4: Create Systemd Service

Create `/etc/systemd/system/stockmarket-api.service`:

```ini
[Unit]
Description=Stock Market API
After=network.target

[Service]
WorkingDirectory=/var/www/stockmarket-api
ExecStart=/usr/bin/dotnet /var/www/stockmarket-api/StockMarketAPI.dll
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=stockmarket-api
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
```

### Step 5: Configure Firewall

```bash
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
```

### Step 6: Start the Service

```bash
sudo systemctl daemon-reload
sudo systemctl enable stockmarket-api
sudo systemctl start stockmarket-api
sudo systemctl status stockmarket-api
```

### Step 7: Configure Reverse Proxy (Optional but Recommended)

Install Nginx:
```bash
sudo dnf install nginx
```

Configure `/etc/nginx/conf.d/stockmarket-api.conf`:
```nginx
server {
    listen 80;
    server_name your-server-domain.com;

    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Start Nginx:
```bash
sudo systemctl enable nginx
sudo systemctl start nginx
```

---

## Frontend Configuration Update

After deploying the backend, update the Angular service:

**File**: `src/app/services/stock-service.ts`

Change line 10 from:
```typescript
private apiUrl = 'http://localhost:3000/stocks';
```

To:
```typescript
private apiUrl = 'http://your-fedora-server:5000/api/stocks';
```

Or if using Nginx reverse proxy:
```typescript
private apiUrl = 'http://your-server-domain.com/api/stocks';
```

**That's the ONLY change required in the frontend code.**

---

## Testing the API

### Using curl:

```bash
# Get all stocks
curl http://localhost:5000/api/stocks

# Get single stock
curl http://localhost:5000/api/stocks/2

# Create new stock
curl -X POST http://localhost:5000/api/stocks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Tesla Inc.",
    "code": "TSLA",
    "price": 242.50,
    "previousPrice": 238.75,
    "exchange": "NASDAQ",
    "favorite": false
  }'

# Delete stock
curl -X DELETE http://localhost:5000/api/stocks/2
```

### Using Swagger UI:
Navigate to `http://localhost:5000/swagger` to test all endpoints interactively.

---

## Security Considerations

### For Production Deployment:

1. **HTTPS**: Enable HTTPS using Let's Encrypt certificates
2. **CORS**: Restrict CORS to specific frontend domain only
3. **Authentication**: Add JWT authentication if needed
4. **Rate Limiting**: Implement rate limiting to prevent abuse
5. **Input Validation**: Ensure all inputs are validated
6. **SQL Injection**: Use parameterized queries (EF Core handles this)
7. **Environment Variables**: Store sensitive data in environment variables

### Example HTTPS Configuration:

```csharp
builder.Services.AddHttpsRedirection(options =>
{
    options.RedirectStatusCode = StatusCodes.Status307TemporaryRedirect;
    options.HttpsPort = 443;
});
```

---

## Troubleshooting

### Common Issues:

1. **CORS Errors**: Ensure CORS policy includes the frontend URL
2. **Database Connection**: Verify connection string and database server is running
3. **Port Already in Use**: Change port in `appsettings.json`
4. **Firewall Blocking**: Ensure port 5000 is open on Fedora server
5. **JSON Serialization**: Ensure property names match exactly (case-sensitive)

### Logs Location:
```bash
sudo journalctl -u stockmarket-api -f
```

---

## Summary

This backend API implementation provides:
- ✅ RESTful API endpoints matching json-server behavior
- ✅ Proper HTTP status codes and response formats
- ✅ Database persistence with Entity Framework Core
- ✅ CORS configuration for Angular frontend
- ✅ Production-ready deployment on Fedora server
- ✅ Minimal frontend changes (only apiUrl update)
- ✅ Swagger documentation for testing
- ✅ Systemd service for automatic startup

The frontend will work seamlessly with this backend by simply changing the `apiUrl` configuration.
